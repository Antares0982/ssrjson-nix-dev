name: "Cache Nix Flake Result (cachix)"
on:
  workflow_dispatch:
    inputs:
      do-update:
        description: 'Set to true to update and commit flake.lock'
        required: true
        default: true
        type: boolean
      new-branch:
        description: 'Set to true to push updates to a new branch'
        required: true
        default: false
        type: boolean
  push:
    branches:
      - "dev"
  schedule:
    - cron: '0 11 * * *'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: Set flag
      run: |
        echo "${{ github.event_name }}"
        if [ "${{ github.event_name }}" == "schedule" ]; then
          echo "DO_UPDATE=false" >> $GITHUB_ENV
          echo "DO_PUSH_NEW_BRANCH=true" >> $GITHUB_ENV
        elif [ "${{ github.event_name }}" == "push" ]; then
          echo "DO_UPDATE=false" >> $GITHUB_ENV
          echo "DO_PUSH_NEW_BRANCH=false" >> $GITHUB_ENV
        else
          echo "DO_UPDATE=${{ github.event.inputs.do-update }}" >> $GITHUB_ENV
          echo "DO_PUSH_NEW_BRANCH=${{ github.event.inputs.new-branch }}" >> $GITHUB_ENV
        fi
    # - name: Maximize build space
    #   if: env.DO_UPDATE == 'true' || env.DO_PUSH_NEW_BRANCH == 'true'
    #   uses: easimon/maximize-build-space@master
    #   with:
    #     build-mount-path: '/nix'
    #     remove-dotnet: 'true'
    #     remove-android: 'true'
    #     remove-haskell: 'true'
    #     remove-codeql: 'true'
    #     remove-docker-images: 'true'
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: '${{ secrets.ACTION_GITHUB_TOKEN }}'
    - name: Install nix
      uses: cachix/install-nix-action@master
      with:
        github_access_token: '${{ secrets.ACTION_GITHUB_TOKEN }}'
    - name: Set nix daemon tmp path
      if: env.DO_UPDATE == 'true' || env.DO_PUSH_NEW_BRANCH == 'true'
      run: |
        sudo mkdir --parents /nix/tmp
        sudo chmod 777 /nix/tmp

        cat > override.conf <<EOF
        [Service]
        Environment="TMPDIR=/nix/tmp"
        EOF
        sudo mkdir /etc/systemd/system/nix-daemon.service.d/
        sudo mv override.conf /etc/systemd/system/nix-daemon.service.d/override.conf
        sudo systemctl daemon-reload
        sudo systemctl restart nix-daemon
    - name: Import GPG key
      if: env.DO_UPDATE == 'true' || env.DO_PUSH_NEW_BRANCH == 'true'
      id: import-gpg
      uses: crazy-max/ghaction-import-gpg@master
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.PASSPHRASE }}
        git_user_signingkey: true
        git_commit_gpgsign: true
    - name: Configure git credentials
      if: env.DO_UPDATE == 'true' || env.DO_PUSH_NEW_BRANCH == 'true'
      run: |
        git config --global user.email "${{ steps.import-gpg.outputs.email }}"
        git config --global user.name "${{ steps.import-gpg.outputs.name }}"
    - name: Setup cachix
      uses: cachix/cachix-action@master
      with:
        name: antares0982
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Nix flake update
      if: env.DO_UPDATE == 'true'
      run: |
        nix --option commit-lockfile-summary "flake.lock: Update [skip ci]" flake update --commit-lock-file
    - name: Test Nix Develop
      run: |
        ./devshell-test.sh
        if [ "$DO_UPDATE" = "true" ]; then
          if [ -z $(git status --porcelain) ]; then
            echo "clean, skip..."
          else
            git add --all
            git commit --message "Flake Update"
          fi
        fi
    - name: Git push
      if: env.DO_UPDATE == 'true'
      run: |
        git config --global pull.rebase false
        git pull
        git push
    - name: Nix flake update (new branch)
      if: env.DO_PUSH_NEW_BRANCH == 'true'
      run: |
        set -euo pipefail
        before_sha=$(git rev-parse HEAD)
        nix --option commit-lockfile-summary "flake.lock: Update [skip ci]" flake update --commit-lock-file || true
        after_sha=$(git rev-parse HEAD)
        if [ "$before_sha" = "$after_sha" ]; then
          echo "No flake.lock update -> skip creating branch"
          exit 0
        fi

        # try to extract nixpkgs revision from flake.lock (robust against common formats)
        rev=$(jq -r '
          ( .nodes["nixpkgs"]?.locked.rev
          // .nodes["nixpkgs"]?.locked.revision
          // (.nodes[]?.locked.rev // .nodes[]?.locked.revision)
          // .locks["nixpkgs"]?.locked.rev
          // .locks["nixpkgs"]?.locked.revision
          )' flake.lock 2>/dev/null | head -n1 || true)
        if [ -z "$rev" ] || [ "$rev" = "null" ]; then
          # fallback to timestamped branch if revision not found
          rev=$(date -u +"%Y%m%dT%H%M%SZ")
        fi
        short_rev=${rev:0:12}
        branch="flake-update/nixpkgs-${short_rev}"
        git checkout -b "$branch"
        echo "$branch" > .github/flake-update-branch.txt
    - name: Test Nix Develop (new branch)
      if: env.DO_PUSH_NEW_BRANCH == 'true'
      run: |
        set -euo pipefail
        # if no branch was created, skip
        if [ ! -f .github/flake-update-branch.txt ]; then
          echo "No update branch created -> skip tests"
          exit 0
        fi
        branch=$(cat .github/flake-update-branch.txt)
        echo "Running tests on branch: $branch"
        # allow tests to fail without failing the job; capture exit code
        set +e
        ./devshell-test.sh
        test_exit_code=$?
        set -e

        if [ "$test_exit_code" -ne 0 ]; then
          echo "Tests failed on branch $branch â€” not pushing."
          exit 0
        fi

        # push new branch to remote (remote branch doesn't exist yet)
        git push --set-upstream origin "$branch"
        echo "Pushed branch $branch"
